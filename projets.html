<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Projets – Tableau d'information</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#0b1020;color:#e6ebff}
    .container{max-width:900px;margin:0 auto;padding:28px}
    .panel{background:#121a2f;border:1px solid #233055;border-radius:16px;padding:20px;margin-bottom:18px}
    input,textarea,button{background:#0f1630;color:#e6ebff;border:1px solid #233055;border-radius:10px;padding:10px 14px;width:100%}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .hidden{display:none}
    a{color:#9db8ff}
    ul{margin-top:10px}
  </style>
</head>
<body>
  <div class="container">
    <h1>Projets</h1>

    <div class="panel" id="list-panel">
      <h2>Liste (lecture)</h2>
      <ul id="list"></ul>
      <p class="muted">Cette vue est visible pour tous.</p>
    </div>

    <div class="panel hidden" id="edit-panel">
      <h2>Édition (éditeur/admin)</h2>
      <div class="row" style="flex-direction:column">
        <input id="pname" placeholder="Nom du projet" />
        <textarea id="pdesc" rows="4" placeholder="Description"></textarea>
        <button id="add">Ajouter / Mettre à jour</button>
      </div>
      <p class="muted">Astuce : le contenu est stocké dans <code>localStorage</code> (démo). Pas de persistance serveur.</p>
    </div>

    <p><a href="index.html">← Retour à l’accueil</a></p>
  </div>

  <script>
// --- CONFIG ---
  const ROLE = localStorage.getItem('role') || 'viewer';
  const RAW_URL = "https://gist.githubusercontent.com/chrisvankerre-a11y/88c2d18e8025bfa5634c99b39e780d06/raw/projets.json";
  const API_PROXY = "https://aged-block-6820.chrisvankerre.workers.dev/write";

  const editPanel = document.getElementById('edit-panel');
  if (ROLE === 'editor' || ROLE === 'admin') editPanel.classList.remove('hidden');

  const listEl = document.getElementById('list');

  async function loadProjects() {
    try {
      const r = await fetch(RAW_URL, { cache: "no-store" });
      if (!r.ok) throw new Error("raw fetch failed");
      const txt = await r.text();
      const data = JSON.parse(txt || "[]");
      render(data);
      return data;
    } catch (e) {
      console.error(e);
      listEl.innerHTML = '<li>Erreur de chargement.</li>';
      return [];
    }
  }

  function render(arr) {
    listEl.innerHTML = '';
    if (!Array.isArray(arr) || arr.length === 0) {
      listEl.innerHTML = '<li>(Aucun projet)</li>';
      return;
    }
    for (const p of arr) {
      const li = document.createElement('li');
      li.innerHTML = `<strong>${escapeHTML(p.name || '')}</strong> — ${escapeHTML(p.desc || '')}`;
      listEl.appendChild(li);
    }
  }

  function escapeHTML(s) {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  document.getElementById('add')?.addEventListener('click', async () => {
    if (!(ROLE === 'editor' || ROLE === 'admin')) {
      alert("Droits insuffisants.");
      return;
    }
    const name = document.getElementById('pname').value.trim();
    const desc = document.getElementById('pdesc').value.trim();
    if (!name) return alert('Nom du projet requis.');

    const current = await loadProjects();
    const idx = current.findIndex(x => (x.name || '').toLowerCase() === name.toLowerCase());
    if (idx >= 0) current[idx].desc = desc; else current.push({ name, desc });

    const res = await fetch(API_PROXY, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data: current })
    });

    if (!res.ok) {
      const t = await res.text();
      console.error(t);
      alert("Échec de la sauvegarde.");
      return;
    }

    const fresh = await loadProjects();
    render(fresh);
    document.getElementById('pname').value = '';
    document.getElementById('pdesc').value = '';
  });

  loadProjects();

  </script>
</body>
</html>


